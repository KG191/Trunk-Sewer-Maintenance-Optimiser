<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trunk Sewer Maintenance Optimizer Pro</title>
    <style>
        :root {
            --primary-blue: #007AFF;
            --secondary-blue: #5AC8FA;
            --success-green: #30D158;
            --warning-orange: #FF9F0A;
            --error-red: #FF3B30;
            --background-primary: #F2F2F7;
            --background-secondary: #FFFFFF;
            --background-tertiary: #F8F9FA;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --border-color: #C6C6C8;
            --shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-heavy: 0 8px 25px rgba(0,0,0,0.2);
            --radius-small: 8px;
            --radius-medium: 12px;
            --radius-large: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;
            background: var(--background-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
            line-height: 1.5;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--background-secondary);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .app-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 400;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: var(--radius-small);
            font-size: 14px;
            font-weight: 500;
        }

        .status-ready { background: #E3F2E3; color: #2A7A2A; }
        .status-processing { background: #FFF3CD; color: #856404; }
        .status-fallback { background: #FFF3CD; color: #856404; border: 1px solid #FFEAA7; }
        .status-error { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        
        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            font-size: 14px;
            font-weight: 500;
        }
        
        .notification.success {
            background: #D4EDDA;
            color: #155724;
            border-left: 4px solid #28A745;
        }
        
        .notification.warning {
            background: #FFF3CD;
            color: #856404;
            border-left: 4px solid #FFC107;
        }
        
        .notification.error {
            background: #F8D7DA;
            color: #721C24;
            border-left: 4px solid #DC3545;
        }
        
        .notification.info {
            background: #D1ECF1;
            color: #0C5460;
            border-left: 4px solid #17A2B8;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Tab Navigation */
        .tab-navigation {
            background: var(--background-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 30px;
        }

        .tab-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }

        .tab-button {
            background: transparent;
            border: none;
            padding: 16px 24px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            white-space: nowrap;
        }

        .tab-button:hover {
            color: var(--primary-blue);
            background: rgba(0, 122, 255, 0.05);
        }

        .tab-button.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-blue);
            transform: scaleX(0);
            transition: transform 0.2s ease;
        }

        .tab-button.active::after {
            transform: scaleX(1);
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-pane {
            display: none;
            height: 100%;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            overflow-y: auto;
        }

        .tab-pane.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--background-secondary);
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .card-content {
            padding: 24px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 16px;
            background: var(--background-secondary);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-input:hover {
            border-color: #999999;
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 16px;
            background: var(--background-secondary);
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-small);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--background-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #E5E5EA;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background: #28B946;
        }

        .btn-warning {
            background: var(--warning-orange);
            color: white;
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 16px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-medium);
            padding: 40px;
            text-align: center;
            background: var(--background-tertiary);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary-blue);
            background: rgba(0, 122, 255, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary-blue);
            background: rgba(0, 122, 255, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .upload-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* Results */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--background-secondary);
            border-radius: var(--radius-medium);
            padding: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .metric-change {
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
        }

        .change-positive { color: var(--success-green); }
        .change-negative { color: var(--error-red); }

        /* Schedule Items */
        .schedule-list {
            background: var(--background-secondary);
            border-radius: var(--radius-medium);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .schedule-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-item:last-child {
            border-bottom: none;
        }

        .schedule-info h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .schedule-details {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .risk-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-high { background: #FFE5E5; color: #D70015; }
        .risk-medium { background: #FFF4E5; color: #D27500; }
        .risk-low { background: #E5F7E5; color: #1B7A1B; }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Introduction specific styles */
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px;
            border-radius: var(--radius-large);
            margin-bottom: 30px;
            text-align: center;
        }

        .hero-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 16px;
            letter-spacing: -1px;
        }

        .hero-subtitle {
            font-size: 20px;
            opacity: 0.9;
            margin-bottom: 32px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }

        .feature-card {
            background: var(--background-secondary);
            border-radius: var(--radius-medium);
            padding: 30px;
            text-align: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }

        .process-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
            background: var(--background-secondary) !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .npv-param-checkbox {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .feature-icon {
            font-size: 40px;
            margin-bottom: 20px;
            color: var(--primary-blue);
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .feature-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* File upload styles */
        .file-input {
            display: none;
        }

        .file-info {
            background: #E3F2E3;
            border: 1px solid #B3D9B3;
            border-radius: var(--radius-small);
            padding: 16px;
            margin-top: 16px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #E5E5EA;
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-blue);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .tab-container {
                overflow-x: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .tab-container::-webkit-scrollbar {
                display: none;
            }

            .tab-pane {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .hero-title {
                font-size: 36px;
            }

            .hero-subtitle {
                font-size: 18px;
            }
        }
    </style>
    
    <!-- Google Maps API Script - Loaded with proper async pattern -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry,marker&callback=initGoogleMaps&loading=async"
        onerror="handleGoogleMapsError()">
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div>
                    <h1 class="app-title">Trunk Sewer Maintenance Optimizer</h1>
                    <p class="app-subtitle">Advanced Risk-Based Infrastructure Planning</p>
                </div>
                <div class="header-actions">
                    <div class="status-indicator status-ready">
                        <span>●</span>
                        <span id="systemStatus">Ready</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <div class="tab-container">
                <button class="tab-button active" onclick="showTab('introduction')">Introduction</button>
                <button class="tab-button" onclick="showTab('instructions')">Instructions</button>
                <button class="tab-button" onclick="showTab('asset-data')">Asset Data</button>
                <button class="tab-button" onclick="showTab('manual-entry')">Manual Entry</button>
                <button class="tab-button" onclick="showTab('optimization')">Optimization & Results</button>
                <button class="tab-button" onclick="showTab('technical-notes')">Technical Notes</button>
                <button class="tab-button" onclick="showTab('mapped-locations')">🗺️ Mapped Locations</button>
            </div>
        </nav>

        <!-- Tab Content -->
        <main class="tab-content">
            <!-- Tab 1: Introduction -->
            <div id="introduction" class="tab-pane active">
                <div class="hero-section">
                    <h1 class="hero-title">Infrastructure Excellence</h1>
                    <p class="hero-subtitle">Optimize trunk sewer maintenance with advanced constraint-based modeling and risk assessment</p>
                    <button class="btn btn-secondary btn-lg" onclick="showTab('instructions')">Get Started →</button>
                </div>

                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon">🎯</div>
                        <h3 class="feature-title">Risk-Based Prioritization</h3>
                        <p class="feature-description">Advanced algorithms prioritize maintenance based on condition, consequence, and operational constraints</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">⚙️</div>
                        <h3 class="feature-title">Constraint Optimization</h3>
                        <p class="feature-description">Considers asset characteristics, resource capacity, and proximity benefits for optimal scheduling</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📊</div>
                        <h3 class="feature-title">Data-Driven Insights</h3>
                        <p class="feature-description">Upload spreadsheets or generate sample data to model real-world maintenance scenarios</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🔄</div>
                        <h3 class="feature-title">Multi-Year Planning</h3>
                        <p class="feature-description">Strategic planning across multiple years with budget and resource constraint management</p>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Instructions -->
            <div id="instructions" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">How to Use the Optimizer</h2>
                        <p class="card-subtitle">Follow these steps to optimize your trunk sewer maintenance program</p>
                    </div>
                    <div class="card-content">
                        <div style="display: grid; gap: 24px;">
                            <div style="display: flex; gap: 20px; padding: 20px; background: var(--background-tertiary); border-radius: var(--radius-small);">
                                <div style="background: var(--primary-blue); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                                <div>
                                    <h3 style="margin-bottom: 8px;">Prepare Your Data</h3>
                                    <p style="color: var(--text-secondary);">Upload a CSV file with your trunk main assets or use the sample data generator. Required fields include ID, length, diameter, condition, and consequence ratings.</p>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 20px; padding: 20px; background: var(--background-tertiary); border-radius: var(--radius-small);">
                                <div style="background: var(--primary-blue); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                                <div>
                                    <h3 style="margin-bottom: 8px;">Configure Parameters</h3>
                                    <p style="color: var(--text-secondary);">Set your resource constraints including annual budget, crew capacity, and production rates. Adjust constraint parameters for access difficulty, bypass requirements, and mobilization complexity.</p>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 20px; padding: 20px; background: var(--background-tertiary); border-radius: var(--radius-small);">
                                <div style="background: var(--primary-blue); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">3</div>
                                <div>
                                    <h3 style="margin-bottom: 8px;">Run Optimization</h3>
                                    <p style="color: var(--text-secondary);">Execute the constraint-based optimization algorithm to generate a multi-year maintenance schedule that balances risk reduction with cost efficiency.</p>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 20px; padding: 20px; background: var(--background-tertiary); border-radius: var(--radius-small);">
                                <div style="background: var(--primary-blue); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">4</div>
                                <div>
                                    <h3 style="margin-bottom: 8px;">Review Results</h3>
                                    <p style="color: var(--text-secondary);">Analyze the optimized schedule, cost projections, and resource utilization. Export results or adjust parameters to explore alternative scenarios.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Key Constraints Explained</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-row">
                            <div>
                                <h4 style="margin-bottom: 8px; color: var(--primary-blue);">Asset Characteristics</h4>
                                <ul style="color: var(--text-secondary); line-height: 1.8;">
                                    <li>Length and diameter limitations</li>
                                    <li>Access difficulty scoring (1-10)</li>
                                    <li>Condition and consequence ratings</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 8px; color: var(--primary-blue);">Operational Constraints</h4>
                                <ul style="color: var(--text-secondary); line-height: 1.8;">
                                    <li>Bypass requirements and setup costs</li>
                                    <li>Mobilization complexity factors</li>
                                    <li>Proximity coordination benefits</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Asset Data Management -->
            <div id="asset-data" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Asset Data Management</h2>
                        <p class="card-subtitle">Upload your asset data or download our template to get started</p>
                    </div>
                    <div class="card-content">
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                            <div class="upload-icon">☁️</div>
                            <h3 class="upload-title">Upload Asset Data</h3>
                            <p class="upload-subtitle">Drag and drop your CSV file here, or click to browse<br>Maximum file size: 10MB</p>
                            
                            <input type="file" id="fileInput" class="file-input" accept=".csv" onchange="handleFileUpload(event)">
                            
                            <div style="margin-top: 24px;">
                                <button class="btn btn-primary">
                                    📁 Choose File
                                </button>
                                <button class="btn btn-secondary" onclick="downloadSampleTemplate()" style="margin-left: 12px;">
                                    📋 Download Template
                                </button>
                            </div>
                            
                            <div id="fileInfo" class="file-info" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Required CSV Format</h2>
                    </div>
                    <div class="card-content">
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">Your CSV file must include the following columns:</p>
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 20px; font-family: monospace; font-size: 12px; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <tr style="background: #f0f7ff;">
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">Asset ID</th>
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">Length (m)</th>
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">Size</th>
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">Risk Rating</th>
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">Recommended Year for Maintenance</th>
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">Access score</th>
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">Bypass required</th>
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">Mobilization complexity</th>
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">X_Coord</th>
                                    <th style="padding: 6px; border: 1px solid var(--border-color); text-align: center;">Y_Coord</th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Generate Sample Data</h2>
                        <p class="card-subtitle">Create realistic sample data for testing and demonstration</p>
                    </div>
                    <div class="card-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Number of Trunk Mains</label>
                                <input type="number" id="numMains" class="form-input" min="1" max="1000" value="15">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Planning Periods (years)</label>
                                <input type="number" id="planningPeriods" class="form-input" min="1" max="20" value="5">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="generateAssets()">
                            🎲 Generate Sample Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Manual Entry -->
            <div id="manual-entry" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Constraint Parameters</h2>
                    </div>
                    <div class="card-content">
                        <h3 style="margin-bottom: 16px; color: var(--primary-blue);">Asset Limits</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Minimum Diameter (mm)</label>
                                <input type="number" id="minDiameter" class="form-input" min="300" max="1200" value="600">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Length per Year (m)</label>
                                <input type="number" id="maxLength" class="form-input" min="500" max="5000" value="2000">
                            </div>
                        </div>

                        <h3 style="margin: 24px 0 16px 0; color: var(--primary-blue);">Access & Bypass</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Access Difficulty Penalty</label>
                                <select id="accessPenalty" class="form-select">
                                    <option value="1.0">No Penalty (0%)</option>
                                    <option value="1.2" selected>Medium Penalty (20%)</option>
                                    <option value="1.5">High Penalty (50%)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Access Threshold Score (1-10)</label>
                                <input type="number" id="accessThreshold" class="form-input" min="1" max="10" value="7">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bypass Time Delay (days)</label>
                                <input type="number" id="bypassTimeDelay" class="form-input" min="0" max="30" value="10">
                            </div>
                        </div>

                        <h3 style="margin: 24px 0 16px 0; color: var(--primary-blue);">Mobilization & Proximity</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Mobilization Complexity Threshold (1-5)</label>
                                <input type="number" id="mobComplexThreshold" class="form-input" min="1" max="5" value="3">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Proximity Radius (m)</label>
                                <input type="number" id="proximityRadius" class="form-input" min="100" max="2000" value="500">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Proximity Coordination Bonus (%)</label>
                                <input type="number" id="proximityBonus" class="form-input" min="5" max="30" value="15">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Planning Periods (Years)</label>
                                <input type="number" id="planningPeriods" class="form-input" min="1" max="10" value="5">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="optimization" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Run Optimization</h2>
                        <p class="card-subtitle">Execute the constraint-based optimization algorithm</p>
                    </div>
                    <div class="card-content">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <button class="btn btn-primary btn-lg" onclick="optimizeSchedule()">
                                🚀 Optimize Maintenance Schedule
                            </button>
                        </div>
                        <div class="progress-bar" id="progressBar" style="display: none;">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                </div>

                <div id="resultsSection" style="display: none;">
                    <div class="results-grid">
                        <div class="metric-card">
                            <div class="metric-value" style="color: var(--primary-blue);" id="totalCost">-</div>
                            <div class="metric-label">Total Length Scheduled</div>
                            <div class="metric-change change-positive" id="costChange">Optimized</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" style="color: var(--success-green);" id="riskReduction">-</div>
                            <div class="metric-label">High Risk Assets Covered</div>
                            <div class="metric-change change-positive" id="riskChange">High risk assets covered</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" style="color: var(--warning-orange);" id="assetsScheduled">-</div>
                            <div class="metric-label">Assets Scheduled</div>
                            <div class="metric-change" id="assetChange">of total inventory</div>
                        </div>
                    </div>


                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Optimized Maintenance Schedule</h2>
                            <p class="card-subtitle">Multi-year prioritized maintenance program sorted by technical score</p>
                            <div style="margin-top: 12px;">
                                <span style="background: var(--background-tertiary); padding: 4px 8px; border-radius: 4px; font-size: 12px; color: var(--text-secondary);">
                                    💡 Higher scores indicate better technical efficiency and scheduling alignment
                                </span>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="scheduleResults" class="schedule-list"></div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info" id="infoAlert">
                    <p>🚀 Upload asset data or generate sample data, then run the optimization to see results.</p>
                </div>
            </div>

            <!-- Tab 6: Technical Notes -->
            <div id="technical-notes" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Methodology Overview</h2>
                        <p class="card-subtitle">Understanding the optimization approach and mathematical framework</p>
                    </div>
                    <div class="card-content">
                        <h3 style="margin-bottom: 16px; color: var(--primary-blue);">Problem Formulation</h3>
                        <p style="margin-bottom: 16px; line-height: 1.6;">This application solves a <strong>Multi-Objective Integer Programming</strong> problem that optimizes trunk sewer maintenance scheduling. The system balances two competing objectives:</p>
                        <ul style="margin-bottom: 20px; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Minimize Total Cost:</strong> Reduce direct maintenance costs including mobilization, bypass setup, and labor</li>
                            <li><strong>Maximize Risk Reduction:</strong> Address high-risk assets first to prevent system failures and emergency repairs</li>
                        </ul>
                        
                        <h3 style="margin-bottom: 16px; color: var(--primary-blue);">Mathematical Model</h3>
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 20px; margin: 16px 0; font-family: monospace; font-size: 14px;">
                            <strong>Decision Variables:</strong><br>
                            • x<sub>i,t</sub> = 1 if asset i is maintained in year t, 0 otherwise<br>
                            • y<sub>i,j</sub> = 1 if assets i and j are coordinated for proximity benefits<br><br>
                            <strong>Objective Function:</strong><br>
                            Minimize: Σ[C<sub>i,t</sub> × x<sub>i,t</sub> + R<sub>i</sub> × (1 - Σx<sub>i,t</sub>)] - Σ[S<sub>i,j</sub> × y<sub>i,j</sub>]
                        </div>
                        
                        <div style="background: #f0f7ff; border: 1px solid var(--primary-blue); border-radius: var(--radius-small); padding: 16px; margin: 16px 0;">
                            <h4 style="color: var(--primary-blue); margin-bottom: 12px;">📖 Variable Legend</h4>
                            <div style="font-size: 14px; line-height: 1.6;">
                                <strong>C<sub>i,t</sub></strong> = Total maintenance cost for asset i in period t<br>
                                <strong>R<sub>i</sub></strong> = Risk cost (consequence of deferring maintenance for asset i)<br>
                                <strong>S<sub>i,j</sub></strong> = Cost savings from coordinating assets i and j<br>
                                <strong>x<sub>i,t</sub></strong> = Binary decision variable (maintain asset i in year t)<br>
                                <strong>y<sub>i,j</sub></strong> = Binary coordination variable (coordinate assets i and j)<br><br>
                                <em style="color: var(--text-secondary);">The objective minimizes total costs while maximizing coordination savings</em>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 16px; color: var(--primary-blue);">Constraint Categories</h3>
                        <div class="form-row">
                            <div>
                                <h4 style="margin-bottom: 8px;">Resource Constraints</h4>
                                <ul style="color: var(--text-secondary); line-height: 1.8; font-size: 14px;">
                                    <li>Annual budget limitations</li>
                                    <li>Crew capacity and equipment availability</li>
                                    <li>Production rate constraints</li>
                                    <li>Working day limitations</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 8px;">Physical Constraints</h4>
                                <ul style="color: var(--text-secondary); line-height: 1.8; font-size: 14px;">
                                    <li>Minimum diameter thresholds</li>
                                    <li>Maximum project length limits</li>
                                    <li>Access difficulty penalties</li>
                                    <li>Bypass requirement considerations</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Proximity Optimization Algorithm</h2>
                        <p class="card-subtitle">Advanced geospatial coordination using Google Maps API</p>
                    </div>
                    <div class="card-content">
                        <h3 style="margin-bottom: 16px; color: var(--primary-blue);">Geospatial Analysis Process</h3>
                        <div style="display: grid; gap: 20px;">
                            <div class="process-card" style="display: flex; gap: 15px; padding: 16px; background: var(--background-tertiary); border-radius: var(--radius-small); border-left: 4px solid var(--primary-blue); transition: all 0.3s ease; cursor: pointer;">
                                <div style="background: var(--primary-blue); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; font-size: 14px;">1</div>
                                <div>
                                    <h4 style="margin-bottom: 6px;">Distance Calculation</h4>
                                    <p style="color: var(--text-secondary); font-size: 14px;">Uses Google Maps Geometry Library to calculate precise distances between asset coordinates using the haversine formula for geographic accuracy.</p>
                                </div>
                            </div>
                            
                            <div class="process-card" style="display: flex; gap: 15px; padding: 16px; background: var(--background-tertiary); border-radius: var(--radius-small); border-left: 4px solid var(--success-green); transition: all 0.3s ease; cursor: pointer;">
                                <div style="background: var(--success-green); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; font-size: 14px;">2</div>
                                <div>
                                    <h4 style="margin-bottom: 6px;">Proximity Filtering</h4>
                                    <p style="color: var(--text-secondary); font-size: 14px;">Identifies assets within 500m radius that are scheduled within 12 months and belong to the same diameter category (< DN600 or ≥ DN600).</p>
                                </div>
                            </div>
                            
                            <div class="process-card" style="display: flex; gap: 15px; padding: 16px; background: var(--background-tertiary); border-radius: var(--radius-small); border-left: 4px solid var(--warning-orange); transition: all 0.3s ease; cursor: pointer;">
                                <div style="background: var(--warning-orange); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; font-size: 14px;">3</div>
                                <div>
                                    <h4 style="margin-bottom: 6px;">Coordination Benefits</h4>
                                    <p style="color: var(--text-secondary); font-size: 14px;">Applies cost savings through shared mobilization, reduced traffic management, and coordinated resource deployment.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #FFF4E5; border: 1px solid var(--warning-orange); border-radius: var(--radius-small); padding: 20px; margin-top: 20px;">
                            <h4 style="color: var(--warning-orange); margin-bottom: 12px; font-size: 16px;">🔧 Google Maps API Setup Required</h4>
                            
                            <div style="background: white; padding: 16px; border-radius: 6px; margin: 12px 0;">
                                <h5 style="color: var(--primary-blue); margin: 0 0 10px 0;">Step 1: Get API Key</h5>
                                <ol style="font-size: 14px; color: #856404; margin: 0; padding-left: 18px;">
                                    <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: var(--primary-blue);">Google Cloud Console</a></li>
                                    <li>Create a new project or select existing project</li>
                                    <li>Click "Create Credentials" → "API Key"</li>
                                    <li>Copy your API key</li>
                                </ol>
                            </div>
                            
                            <div style="background: white; padding: 16px; border-radius: 6px; margin: 12px 0;">
                                <h5 style="color: var(--primary-blue); margin: 0 0 10px 0;">Step 2: Enable Required APIs</h5>
                                <p style="font-size: 14px; color: #856404; margin: 0;">Enable these APIs in your project:</p>
                                <ul style="font-size: 14px; color: #856404; margin: 8px 0 0 0; padding-left: 18px;">
                                    <li><strong>Maps JavaScript API</strong></li>
                                    <li><strong>Geometry Library</strong> (included in Maps JavaScript API)</li>
                                </ul>
                            </div>
                            
                            <div style="background: white; padding: 16px; border-radius: 6px; margin: 12px 0;">
                                <h5 style="color: var(--primary-blue); margin: 0 0 10px 0;">Step 3: Configure Server</h5>
                                <p style="font-size: 14px; color: #856404; margin: 0;">Add your API key to the <code>.env</code> file:</p>
                                <pre style="background: #f4f4f4; padding: 8px; margin: 8px 0; border-radius: 4px; font-size: 12px;">GOOGLE_MAPS_API_KEY=your_actual_api_key_here</pre>
                            </div>
                            
                            <div style="background: #e8f4fd; padding: 12px; border-radius: 6px; margin: 12px 0;">
                                <h5 style="color: var(--primary-blue); margin: 0 0 8px 0;">💡 Testing Proximity</h5>
                                <p style="font-size: 13px; color: var(--primary-blue); margin: 0;">
                                    If proximity shows "No" for all assets, the API may not be working. Check browser console (F12) for errors.
                                    The system will use fallback calculations but with reduced accuracy.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Key Assumptions & Limitations</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-row">
                            <div>
                                <h4 style="margin-bottom: 12px; color: var(--primary-blue);">Model Assumptions</h4>
                                <ul style="color: var(--text-secondary); line-height: 1.7; font-size: 14px;">
                                    <li>Risk ratings remain constant over planning period</li>
                                    <li>Resource costs are stable (no inflation adjustment)</li>
                                    <li>Weather and seasonal factors not considered</li>
                                    <li>Asset deterioration follows linear progression</li>
                                    <li>Bypass availability is guaranteed when required</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 12px; color: var(--primary-blue);">System Limitations</h4>
                                <ul style="color: var(--text-secondary); line-height: 1.7; font-size: 14px;">
                                    <li>Maximum 1000 assets per optimization run</li>
                                    <li>20-year maximum planning horizon</li>
                                    <li>Simplified traffic impact modeling</li>
                                    <li>No integration with SCADA systems</li>
                                    <li>Static crew productivity assumptions</li>
                                </ul>
                            </div>
                        </div>
                        
                        <h3 style="margin: 24px 0 16px 0; color: var(--primary-blue);">Technical Scoring System</h3>
                        <p style="margin-bottom: 16px;">The optimization system uses a comprehensive scoring algorithm based on multiple technical factors:</p>
                        
                        <h4 style="margin: 16px 0 12px 0; color: var(--primary-blue);">🎯 Risk Rating Scoring (1-25 scale)</h4>
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 16px; margin-bottom: 16px;">
                            <ul style="color: var(--text-secondary); line-height: 1.7;">
                                <li><strong>Extreme Risk (20-25 points):</strong> 100 priority points</li>
                                <li><strong>Very High Risk (15-19 points):</strong> 75 priority points</li>
                                <li><strong>High Risk (10-14 points):</strong> 50 priority points</li>
                                <li><strong>Low Risk (1-9 points):</strong> 25 priority points</li>
                            </ul>
                            <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"><em>Risk Rating = Asset Condition (1-5) × Consequence of Failure (1-5)</em></p>
                        </div>

                        <h4 style="margin: 16px 0 12px 0; color: var(--primary-blue);">🔧 Access Scoring (1-10 scale)</h4>
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 16px; margin-bottom: 16px;">
                            <ul style="color: var(--text-secondary); line-height: 1.7;">
                                <li><strong>Good Access (7-10 score):</strong> 20 priority points</li>
                                <li><strong>Moderate Access (4-6 score):</strong> 0 priority points</li>
                                <li><strong>Difficult Access (1-3 score):</strong> 10 priority points (grouped for efficiency)</li>
                            </ul>
                            <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"><em>Higher scores = easier access, with difficult access grouped for operational efficiency</em></p>
                        </div>

                        <h4 style="margin: 16px 0 12px 0; color: var(--primary-blue);">🚚 Mobilization Scoring (1-5 complexity scale)</h4>
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 16px; margin-bottom: 16px;">
                            <ul style="color: var(--text-secondary); line-height: 1.7;">
                                <li><strong>Simple Mobilization (1-2 complexity):</strong> 15 priority points</li>
                                <li><strong>Moderate Mobilization (3 complexity):</strong> 0 priority points</li>
                                <li><strong>Complex Mobilization (4-5 complexity):</strong> 5 priority points (grouped coordination)</li>
                            </ul>
                            <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"><em>Lower complexity = higher efficiency, with complex setups grouped together</em></p>
                        </div>

                        <h4 style="margin: 16px 0 12px 0; color: var(--primary-blue);">⚡ Bypass Requirements</h4>
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 16px; margin-bottom: 16px;">
                            <ul style="color: var(--text-secondary); line-height: 1.7;">
                                <li><strong>No Bypass Required:</strong> 10 priority points</li>
                                <li><strong>Bypass Required:</strong> 5 priority points (coordinated scheduling)</li>
                            </ul>
                            <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"><em>Assets requiring bypass are grouped for resource optimization</em></p>
                        </div>

                        <h4 style="margin: 16px 0 12px 0; color: var(--primary-blue);">🔗 Proximity Coordination</h4>
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 16px; margin-bottom: 16px;">
                            <ul style="color: var(--text-secondary); line-height: 1.7;">
                                <li><strong>Proximity Benefit Achieved:</strong> +20 bonus points</li>
                                <li><strong>No Proximity Coordination:</strong> 0 bonus points</li>
                            </ul>
                            <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"><em>Assets within 500m of same diameter category can be coordinated for efficiency gains</em></p>
                        </div>

                        <h4 style="margin: 16px 0 12px 0; color: var(--primary-blue);">📏 Work Scope Efficiency</h4>
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 16px; margin-bottom: 16px;">
                            <ul style="color: var(--text-secondary); line-height: 1.7;">
                                <li><strong>Substantial Work (≥500m):</strong> 10 priority points</li>
                                <li><strong>Moderate Work (201-499m):</strong> 0 priority points</li>
                                <li><strong>Compact Work (≤200m):</strong> 5 priority points</li>
                            </ul>
                            <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"><em>Optimizes crew utilization and resource deployment efficiency</em></p>
                        </div>

                        <h4 style="margin: 16px 0 12px 0; color: var(--primary-blue);">📅 Timing Alignment</h4>
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 16px;">
                            <ul style="color: var(--text-secondary); line-height: 1.7;">
                                <li><strong>Perfect Timing (recommended year):</strong> 30 priority points</li>
                                <li><strong>Within 1 Year:</strong> 20 priority points</li>
                                <li><strong>Within 2 Years:</strong> 10 priority points</li>
                                <li><strong>Late Maintenance (>2 years):</strong> 5 priority points</li>
                                <li><strong>Early Maintenance (<0 years):</strong> -10 penalty points</li>
                            </ul>
                            <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"><em>Balances asset lifecycle timing with technical efficiency requirements</em></p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">References & Further Reading</h2>
                    </div>
                    <div class="card-content">
                        <div style="line-height: 1.8; color: var(--text-secondary);">
                            <h4 style="color: var(--primary-blue); margin-bottom: 12px;">Academic Literature</h4>
                            <ol style="padding-left: 20px; margin-bottom: 20px;">
                                <li>Kleiner, Y., & Rajani, B. (2001). "Comprehensive review of structural deterioration of water mains." <em>Urban Water</em>, 3(3), 151-164.</li>
                                <li>Dandy, G. C., & Engelhardt, M. (2001). "Optimal scheduling of water pipe replacement using genetic algorithms." <em>Journal of Water Resources Planning and Management</em>, 127(4), 214-223.</li>
                                <li>Scholten, L., et al. (2014). "Strategic rehabilitation planning of piped water networks using multi-criteria decision analysis." <em>Water Research</em>, 49, 124-143.</li>
                                <li>Woodhouse, J. (2003). "Asset Management: Concepts and Practices." The Woodhouse Partnership Ltd.</li>
                            </ol>
                            
                            <h4 style="color: var(--primary-blue); margin-bottom: 12px;">Industry Standards</h4>
                            <ul style="padding-left: 20px; margin-bottom: 20px;">
                                <li>ISO 55000 Series - Asset Management Standards</li>
                                <li>ASCE Manual of Practice No. 92 - Design and Construction of Sanitary Sewers</li>
                                <li>WRc Guidelines for Managing Assets in the Water Industry</li>
                                <li>CIRIA Report C654 - An Introduction to Sewerage Asset Management Planning</li>
                            </ul>
                            
                            <h4 style="color: var(--primary-blue); margin-bottom: 12px;">Software & Algorithms</h4>
                            <ul style="padding-left: 20px;">
                                <li>Operations Research methodologies from Hillier & Lieberman (2015)</li>
                                <li>Google Maps JavaScript API Documentation</li>
                                <li>Constraint Programming techniques (Rossi et al., 2006)</li>
                                <li>Multi-objective optimization algorithms (Coello et al., 2007)</li>
                            </ul>
                        </div>
                        
                        <div style="background: var(--background-tertiary); border-radius: var(--radius-small); padding: 16px; margin-top: 20px;">
                            <p style="font-size: 14px; color: var(--text-secondary); margin: 0;"><strong>Note:</strong> This tool is designed for educational and planning purposes. For critical infrastructure decisions, consult with qualified engineering professionals and conduct detailed site-specific assessments.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 7: Mapped Locations -->
            <div id="mapped-locations" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">🗺️ Mapped Asset Locations</h2>
                        <p class="card-subtitle">Geographic visualization of maintenance priorities with interactive filtering</p>
                    </div>
                    <div class="card-content">
                        <!-- Priority Summary Stats -->
                        <div id="mapStats" style="margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                                <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #007AFF;">0</div>
                                    <div style="font-size: 12px; color: #666;">Total Assets</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: #fef2f2; border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #DC2626;">0</div>
                                    <div style="font-size: 12px; color: #666;">Critical</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: #fffbeb; border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #F59E0B;">0</div>
                                    <div style="font-size: 12px; color: #666;">High Priority</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: #f0fdf4; border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #10B981;">0</div>
                                    <div style="font-size: 12px; color: #666;">Scheduled</div>
                                </div>
                            </div>
                        </div>

                        <!-- Map Controls -->
                        <div class="map-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; padding: 16px; background: var(--background-tertiary); border-radius: var(--radius-small);">
                            <div class="control-group">
                                <label style="font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 8px; display: block;">Priority Level:</label>
                                <select id="priorityFilter" onchange="applyMapFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--radius-small); background: white; font-size: 14px;">
                                    <option value="all">All Priorities</option>
                                    <option value="critical">Critical (150+ points)</option>
                                    <option value="high">High (120-149 points)</option>
                                    <option value="medium">Medium (80-119 points)</option>
                                    <option value="low">Low (&lt;80 points)</option>
                                </select>
                            </div>
                            
                            <div class="control-group">
                                <label style="font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 8px; display: block;">Schedule Status:</label>
                                <select id="scheduleFilter" onchange="applyMapFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--radius-small); background: white; font-size: 14px;">
                                    <option value="all">All Assets</option>
                                    <option value="scheduled">Scheduled Only</option>
                                    <option value="unscheduled">Unscheduled Only</option>
                                </select>
                            </div>
                            
                            <div class="control-group">
                                <label style="font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 8px; display: block;">Schedule Year:</label>
                                <select id="yearFilter" onchange="applyMapFilters()" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--radius-small); background: white; font-size: 14px;">
                                    <option value="all">All Years</option>
                                </select>
                            </div>

                            <div class="control-group">
                                <label style="font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 8px; display: block;">View Controls:</label>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="fitMapToAssets()" style="background: #007AFF; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Fit to Assets</button>
                                    <button onclick="toggleHeatmap()" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Heatmap</button>
                                    <button onclick="exportMapData()" style="background: #6B7280; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Export</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Map Container -->
                        <div id="assetMap" style="height: 600px; width: 100%; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color);"></div>
                        
                        <!-- Map Legend -->
                        <div class="map-legend" style="background: white; border: 1px solid var(--border-color); border-radius: var(--radius-small); padding: 16px;">
                            <h4 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 16px;">Map Legend</h4>
                            <div class="legend-items" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                                <div class="legend-item" style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                    <span class="legend-marker critical" style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); background: #DC2626;"></span>
                                    <span>Critical Priority (150+ points)</span>
                                </div>
                                <div class="legend-item" style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                    <span class="legend-marker high" style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); background: #F59E0B;"></span>
                                    <span>High Priority (120-149 points)</span>
                                </div>
                                <div class="legend-item" style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                    <span class="legend-marker medium" style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); background: #10B981;"></span>
                                    <span>Medium Priority (80-119 points)</span>
                                </div>
                                <div class="legend-item" style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                    <span class="legend-marker low" style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); background: #6B7280;"></span>
                                    <span>Low Priority (&lt;80 points)</span>
                                </div>
                                <div class="legend-item" style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                    <span style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); background: #007AFF;">●</span>
                                    <span>Scheduled Assets</span>
                                </div>
                                <div class="legend-item" style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                    <span style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); background: #6B7280;">○</span>
                                    <span>Unscheduled Assets</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Priority Ranking Card -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">📊 Global Priority Ranking</h2>
                        <p class="card-subtitle">All assets ranked by total score across all years</p>
                        <div style="display: flex; gap: 12px; align-items: center; margin-top: 12px;">
                            <button onclick="togglePriorityView('global')" id="globalViewBtn" class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">Global Priority</button>
                            <button onclick="togglePriorityView('year')" id="yearViewBtn" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">By Year</button>
                            <button onclick="togglePriorityView('risk')" id="riskViewBtn" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">By Risk Level</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="priorityRanking" style="max-height: 400px; overflow-y: auto;">
                            <p style="text-align: center; color: var(--text-secondary); padding: 40px;">Load asset data and run optimization to see priority ranking</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let assets = [];
        let dataSource = 'none';
        let currentTab = 'introduction';
        
        // Suppress Google Maps InvalidKey warnings globally for better UX
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && 
                    (args[0].includes('InvalidKey') || 
                     args[0].includes('google.maps.Marker is deprecated') ||
                     args[0].includes('InvalidKeyMapError'))) {
                    // Silently ignore Google Maps API warnings for better UX
                    return;
                }
                originalWarn.apply(console, args);
            };
        })();
        
        // Google Maps API Status Management
        const apiStatus = {
            status: 'unknown', // 'active', 'fallback', 'error'
            lastCheck: null,
            errorMessage: null,
            fallbackReason: null
        };
        
        // Google Maps API Error Handler
        window.handleGoogleMapsError = function() {
            updateApiStatus('error', 'Failed to load Google Maps API - likely invalid API key');
            showNotification('⚠️ Google Maps API failed to load. Using fallback calculations.', 'warning');
            console.warn('Google Maps API failed to load - check API key configuration');
        };
        
        // Google Maps API Initialization Callback
        window.initGoogleMaps = function() {
            // Check for placeholder API key
            const scriptSrc = document.querySelector('script[src*="googleapis.com"]')?.src || '';
            const hasPlaceholderKey = scriptSrc.includes('key=YOUR_API_KEY');
            
            if (hasPlaceholderKey) {
                updateApiStatus('fallback', 'Placeholder API key detected - using fallback calculations');
                showNotification('🔑 Google Maps API key not configured. Using mathematical calculations.', 'info');
                console.log('Google Maps API key placeholder detected - using fallback mode');
                return;
            }
            
            try {
                // Test API functionality
                const testLocation = new google.maps.LatLng(0, 0);
                const testDistance = google.maps.geometry.spherical.computeDistanceBetween(
                    testLocation, testLocation
                );
                
                // API is working
                updateApiStatus('active');
                showNotification('✅ Google Maps API loaded successfully', 'success');
                console.log('Google Maps API initialized successfully');
                
            } catch (error) {
                // API failed to load or function properly
                let errorMsg = 'API initialization failed';
                let notification = '⚠️ Google Maps API unavailable. Using fallback calculations.';
                
                if (error.message && (error.message.includes('InvalidKey') || error.message.includes('API key'))) {
                    errorMsg = 'Invalid API key - check configuration';
                    notification = '🔑 Google Maps API key invalid. Using fallback calculations.';
                }
                
                updateApiStatus('fallback', errorMsg);
                showNotification(notification, 'warning');
                console.warn('Google Maps API initialization failed:', error);
            }
        };
        
        // Timeout handler for Google Maps API loading
        setTimeout(() => {
            if (apiStatus.status === 'unknown') {
                updateApiStatus('fallback', 'API loading timeout');
                showNotification('⏱️ Google Maps API loading timeout. Using fallback mode.', 'warning');
                console.warn('Google Maps API loading timeout - using fallback mode');
            }
        }, 10000); // 10 second timeout
        
        // API Status Management Functions
        function updateApiStatus(newStatus, reason = null) {
            apiStatus.status = newStatus;
            apiStatus.lastCheck = new Date();
            apiStatus.fallbackReason = reason;
            
            // Update UI indicators
            updateStatusIndicators();
            logStatusChange();
        }
        
        function updateStatusIndicators() {
            const statusElement = document.getElementById('systemStatus');
            const statusContainer = statusElement.parentElement;
            
            switch(apiStatus.status) {
                case 'active':
                    statusElement.textContent = 'Ready (Google Maps API Active)';
                    statusContainer.className = 'status-indicator status-ready';
                    break;
                case 'fallback':
                    statusElement.textContent = 'Ready (Fallback Mode)';
                    statusContainer.className = 'status-indicator status-fallback';
                    break;
                case 'error':
                    statusElement.textContent = 'Ready (API Error)';
                    statusContainer.className = 'status-indicator status-error';
                    break;
                default:
                    statusElement.textContent = 'Ready';
                    statusContainer.className = 'status-indicator status-ready';
            }
        }
        
        function logStatusChange() {
            console.log(`API Status changed to: ${apiStatus.status}`, {
                reason: apiStatus.fallbackReason,
                timestamp: apiStatus.lastCheck
            });
        }
        
        // Notification System
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: inherit; cursor: pointer; font-size: 16px;">×</button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Utility function for weighted random selection
        function getWeightedRandom(items, weights) {
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < items.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return items[i];
                }
            }
            return items[items.length - 1];
        }

        // Tab Management
        function showTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            currentTab = tabId;
        }

        // File upload handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            updateSystemStatus('Processing...', 'status-processing');
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `<strong>📄 File:</strong> ${file.name} (${(file.size/1024).toFixed(1)} KB)<br><em>Processing...</em>`;
            
            if (file.name.endsWith('.csv')) {
                parseCSVFile(file);
            } else {
                alert('Please upload a CSV file. Use "Download Template" for the correct format.');
                return;
            }
        }
        
        function parseCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Validate required columns - map display names to internal names
                const columnMapping = {
                    'asset id': 'id',
                    'length (m)': 'length',
                    'length_m': 'length',
                    'size': 'diameter',
                    'diameter_mm': 'diameter',
                    'risk rating': 'riskCategory',
                    'risk_category': 'riskCategory',
                    'recommended year for maintenance': 'recommendedYear',
                    'access score': 'accessScore',
                    'access_score_1to10': 'accessScore',
                    'bypass required': 'bypassRequired',
                    'bypass_required_yn': 'bypassRequired',
                    'mobilization complexity': 'mobilizationComplexity',
                    'mobilization_complexity_1to5': 'mobilizationComplexity',
                    'x_coord': 'x',
                    'y_coord': 'y',
                    'xcoord': 'x',
                    'ycoord': 'y'
                };
                
                const requiredFields = ['id', 'length', 'diameter', 'riskCategory', 'accessScore', 'bypassRequired', 'mobilizationComplexity', 'x', 'y'];
                
                const missingCols = requiredFields.filter(field => {
                    const mappedField = Object.keys(columnMapping).find(key => columnMapping[key] === field);
                    return !headers.some(h => {
                        const cleanHeader = h.toLowerCase().replace(/[^a-z0-9]/g, '');
                        return cleanHeader === mappedField?.replace(/[^a-z0-9]/g, '') || 
                               Object.keys(columnMapping).some(key => 
                                   columnMapping[key] === field && cleanHeader.includes(key.replace(/[^a-z0-9]/g, ''))
                               );
                    });
                });
                
                if (missingCols.length > 0) {
                    alert(`Missing required columns: ${missingCols.join(', ')}`);
                    updateSystemStatus('Ready', 'status-ready');
                    return;
                }
                
                // Parse data
                assets = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length < headers.length) continue;
                    
                    const asset = {};
                    headers.forEach((header, index) => {
                        const cleanHeader = header.toLowerCase().replace(/[^a-z0-9]/g, '');
                        let value = values[index];
                        
                        if (cleanHeader.includes('id')) asset.id = value;
                        else if (cleanHeader.includes('length')) asset.length = parseFloat(value) || 0;
                        else if (cleanHeader.includes('diameter') || cleanHeader.includes('size')) asset.diameter = parseFloat(value) || 0;
                        else if (cleanHeader.includes('risk')) {
                            // Convert categorical risk rating to numeric
                            const riskMap = {
                                'extreme': 25, 
                                'veryhigh': 20, 'very high': 20,
                                'high': 15, 
                                'moderate': 10, 'medium': 10,
                                'low': 5, 
                                'verylow': 1, 'very low': 1
                            };
                            const normalizedValue = value.toLowerCase().replace(/\s+/g, '');
                            asset.riskScore = riskMap[normalizedValue] || riskMap[value.toLowerCase()] || 10;
                            asset.riskCategory = value;
                        }
                        else if (cleanHeader.includes('recommended') && cleanHeader.includes('year')) asset.recommendedYear = parseInt(value) || new Date().getFullYear();
                        else if (cleanHeader.includes('access')) asset.accessScore = parseInt(value) || 1;
                        else if (cleanHeader.includes('bypass')) asset.bypassRequired = value.toLowerCase().includes('y') || value.toLowerCase().includes('true');
                        else if (cleanHeader.includes('mobilization')) asset.mobilizationComplexity = parseInt(value) || 1;
                        else if (cleanHeader.includes('xcoord') || cleanHeader.includes('x_coord') || cleanHeader.includes('x')) asset.x = parseFloat(value) || 0;
                        else if (cleanHeader.includes('ycoord') || cleanHeader.includes('y_coord') || cleanHeader.includes('y')) asset.y = parseFloat(value) || 0;
                    });
                    
                    // Calculate derived values
                    if (!asset.riskScore) {
                        // Fallback if risk score not set from categorical rating
                        asset.riskScore = 10;
                    }
                    asset.accessDifficulty = asset.accessScore <= 3 ? 'High' : asset.accessScore <= 7 ? 'Medium' : 'Low';
                    
                    // Set default recommended year if not provided
                    if (!asset.recommendedYear) {
                        asset.recommendedYear = new Date().getFullYear();
                    }
                    
                    if (asset && asset.id && asset.length && asset.diameter) {
                        assets.push(asset);
                    } else if (asset && asset.id) {
                        console.log('Skipped asset:', asset.id, 'Missing:', {
                            length: !asset.length,
                            diameter: !asset.diameter,
                            coordinates: !asset.x || !asset.y
                        });
                    }
                }
                
                console.log('Parsed assets:', assets.length, 'Total lines:', lines.length - 1);
                
                // Debug: Check how many assets have high risk scores
                const highRiskCount = assets.filter(asset => asset.riskScore >= 15).length;
                console.log(`Of ${assets.length} assets, ${highRiskCount} are high risk (score >= 15)`);
                
                // Sort by risk score
                assets.sort((a, b) => b.riskScore - a.riskScore);
                
                dataSource = 'uploaded';
                
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `
                    <strong>✅ Successfully loaded:</strong> ${assets.length} trunk mains (${highRiskCount} high risk)<br>
                    <span style="display: inline-block; background: #E3F2E3; color: #2A7A2A; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">Data Source: Uploaded</span>
                `;
                
                updateSystemStatus('Data Loaded', 'status-ready');
            };
            reader.readAsText(file);
        }
        
        function downloadSampleTemplate() {
            const csvContent = 'Asset ID,Length (m),Size,Risk Rating,Recommended Year for Maintenance,Access score,Bypass required,Mobilization complexity,X_Coord,Y_Coord\n' +
                'TM-001,450,600,High,2024,6,Yes,2,1250.5,2300.8\n' +
                'TM-002,620,750,Very High,2024,8,No,3,1850.2,1950.4\n' +
                'TM-003,380,900,Moderate,2025,4,Yes,4,980.7,2800.1\n' +
                'TM-004,720,600,Extreme,2024,9,No,1,2100.3,1200.6\n' +
                'TM-005,290,750,High,2025,7,Yes,2,1600.9,2600.3\n' +
                'TM-006,510,600,Very High,2024,5,Yes,3,2850.3,1850.2\n' +
                'TM-007,340,900,Low,2026,9,No,1,3200.1,2400.7\n' +
                'TM-008,680,750,Extreme,2024,3,Yes,4,1650.8,3100.5\n' +
                'TM-009,420,600,Moderate,2025,7,No,2,2950.4,1750.9\n' +
                'TM-010,590,900,High,2025,6,Yes,3,1450.7,2850.3\n' +
                'TM-011,360,750,Very High,2024,4,No,4,3450.2,1550.8\n' +
                'TM-012,750,600,Extreme,2024,8,Yes,1,1850.5,2950.1\n' +
                'TM-013,480,900,Moderate,2025,6,No,2,2650.9,2150.4\n' +
                'TM-014,320,750,High,2026,7,Yes,3,3150.6,1850.7\n' +
                'TM-015,640,600,Very High,2026,5,No,4,1950.3,3250.2';
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'trunk_mains_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function generateAssets() {
            const numMains = parseInt(document.getElementById('numMains').value);
            const minDiameter = 600; // Default since manual entry is separate
            const maxLength = 800;
            
            updateSystemStatus('Generating...', 'status-processing');
            
            assets = [];
            
            // Generate sample assets with realistic parameters
            for (let i = 1; i <= numMains; i++) {
                const diameter = Math.max(minDiameter, 
                    Math.random() < 0.3 ? 600 : Math.random() < 0.6 ? 750 : 900);
                
                const length = Math.min(maxLength, Math.floor(Math.random() * 800) + 200);
                const riskCategories = ['Extreme', 'Very High', 'High', 'Moderate', 'Low', 'Very Low'];
                const riskWeights = [0.05, 0.1, 0.25, 0.35, 0.2, 0.05]; // Probability weights
                const riskCategory = getWeightedRandom(riskCategories, riskWeights);
                const riskMapping = {
                    'Extreme': 25, 'Very High': 20, 'High': 15, 
                    'Moderate': 10, 'Low': 5, 'Very Low': 1
                };
                const riskScore = riskMapping[riskCategory];
                const recommendedYear = new Date().getFullYear() + Math.floor(Math.random() * 5) + 1; // 2025-2029
                
                const accessScore = Math.floor(Math.random() * 10) + 1;
                const bypassRequired = Math.random() < 0.4;
                const mobilizationComplexity = Math.floor(Math.random() * 5) + 1;
                
                const x = Math.random() * 10000;
                const y = Math.random() * 10000;
                
                assets.push({
                    id: `TM-${String(i).padStart(3, '0')}`,
                    length: length,
                    diameter: diameter,
                    riskCategory: riskCategory,
                    riskScore: riskScore,
                    riskRating: riskScore, // For backward compatibility
                    recommendedYear: recommendedYear,
                    accessScore: accessScore,
                    accessDifficulty: accessScore <= 3 ? 'High' : accessScore <= 7 ? 'Medium' : 'Low',
                    bypassRequired: bypassRequired,
                    mobilizationComplexity: mobilizationComplexity,
                    diameterCategory: diameter < 600 ? 'Small' : 'Large',
                    x: x,
                    y: y
                });
            }
            
            // Sort by risk score
            assets.sort((a, b) => b.riskScore - a.riskScore);
            
            dataSource = 'generated';
            updateSystemStatus('Data Ready', 'status-ready');
            
            // Show success message
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <strong>✅ Generated:</strong> ${numMains} trunk mains with realistic parameters<br>
                <span style="display: inline-block; background: #E3F2E3; color: #2A7A2A; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">Data Source: Generated</span>
            `;
        }
        
        // Technical Efficiency Functions
        
        function getTechnicalSchedulingDrivers(asset, scheduledYear) {
            const recommendedYear = asset.recommendedYear || new Date().getFullYear();
            const yearsDifference = scheduledYear - recommendedYear;
            
            const drivers = [];
            
            // Risk-based prioritization
            if (asset.riskCategory) {
                const riskLevel = asset.riskCategory.toLowerCase();
                if (riskLevel.includes('extreme') || riskLevel.includes('very high')) {
                    drivers.push(`Critical risk level: ${asset.riskCategory}`);
                } else if (riskLevel.includes('high')) {
                    drivers.push(`High risk priority: ${asset.riskCategory}`);
                }
            }
            
            // Technical efficiency factors
            if (asset.accessScore >= 7) drivers.push(`Good accessibility (Score: ${asset.accessScore}/10)`);
            if (asset.accessScore <= 3) drivers.push(`Difficult access - grouped with similar assets`);
            
            if (asset.mobilizationComplexity <= 2) drivers.push(`Simple mobilization (Level: ${asset.mobilizationComplexity}/5)`);
            if (asset.mobilizationComplexity >= 4) drivers.push(`Complex mobilization - coordinated setup`);
            
            if (!asset.bypassRequired) drivers.push('No bypass required - operational efficiency');
            if (asset.bypassRequired) drivers.push('Bypass required - coordinated with similar assets');
            
            // Proximity coordination
            if (asset.proximityBenefit) drivers.push('Proximity coordination with nearby assets');
            
            // Timing optimization
            if (Math.abs(yearsDifference) <= 1) {
                drivers.push('Optimal timing - within recommended window');
            } else if (yearsDifference > 1) {
                drivers.push('Deferred maintenance - managing asset lifecycle');
            } else if (yearsDifference < -1) {
                drivers.push('Early maintenance - technical efficiency grouping');
            }
            
            // Work scope efficiency
            if (asset.length >= 500) drivers.push('Substantial work scope - maximize crew utilization');
            if (asset.length <= 200) drivers.push('Compact scope - efficient resource deployment');
            
            return drivers;
        }
        
        

        function optimizeSchedule() {
            if (assets.length === 0) {
                alert('Please upload asset data or generate sample data first.');
                showTab('asset-data');
                return;
            }
            
            updateSystemStatus('Optimizing...', 'status-processing');
            showProgressBar();
            
            // Get optimization parameters
            const planningPeriods = parseInt(document.getElementById('planningPeriods').value);
            const minDiameter = parseInt(document.getElementById('minDiameter').value);
            const maxLength = parseInt(document.getElementById('maxLength').value);
            const accessPenalty = parseFloat(document.getElementById('accessPenalty').value);
            const accessThreshold = parseInt(document.getElementById('accessThreshold').value);
            const bypassTimeDelay = parseInt(document.getElementById('bypassTimeDelay').value);
            const mobComplexThreshold = parseInt(document.getElementById('mobComplexThreshold').value);
            const proximityRadius = parseFloat(document.getElementById('proximityRadius').value);
            const proximityBonus = parseFloat(document.getElementById('proximityBonus').value) / 100;
            
            // Technical efficiency optimization with constraint handling
            let schedule = [];
            let totalRiskCoverage = 0;
            
            setTimeout(() => {
                updateProgress(25);
                
                for (let year = 1; year <= planningPeriods; year++) {
                    let yearlyLength = 0; // Track total length scheduled this year
                    let yearlyAssets = [];
                    
                    // Filter and sort remaining assets
                    const remainingAssets = assets.filter(asset => {
                        if (asset.diameter < minDiameter) return false;
                        return !schedule.some(scheduled => scheduled.id === asset.id);
                    });
                    
                    updateProgress(25 + (year / planningPeriods) * 50);
                    
                    // Calculate technical efficiency metrics for each asset
                    remainingAssets.forEach(asset => {
                        // Set effective length considering bypass delays
                        if (asset.bypassRequired) {
                            asset.effectiveLength = asset.length + bypassTimeDelay;
                        } else {
                            asset.effectiveLength = asset.length;
                        }
                        
                        // Calculate technical priority score based on multiple factors
                        let technicalScore = 0;
                        
                        // Risk priority (highest weight)
                        if (asset.riskScore >= 20) technicalScore += 100;
                        else if (asset.riskScore >= 15) technicalScore += 75;
                        else if (asset.riskScore >= 10) technicalScore += 50;
                        else technicalScore += 25;
                        
                        // Access efficiency factor
                        if (asset.accessScore >= 7) technicalScore += 20;
                        else if (asset.accessScore <= 3) technicalScore += 10; // Group difficult access
                        
                        // Mobilization efficiency factor
                        if (asset.mobilizationComplexity <= 2) technicalScore += 15;
                        else if (asset.mobilizationComplexity >= 4) technicalScore += 5; // Group complex setups
                        
                        // Bypass coordination factor
                        if (!asset.bypassRequired) technicalScore += 10;
                        else technicalScore += 5; // Group bypass requirements
                        
                        // Work scope efficiency
                        if (asset.length >= 500) technicalScore += 10; // Substantial work
                        else if (asset.length <= 200) technicalScore += 5; // Quick completion
                        
                        // Recommended year alignment (important factor)
                        const recommendedYear = asset.recommendedYear || new Date().getFullYear();
                        const currentActualYear = new Date().getFullYear() + year - 1;  // Convert iteration to actual year
                        const yearsDifference = currentActualYear - recommendedYear;
                        
                        if (yearsDifference === 0) technicalScore += 30; // Perfect timing
                        else if (Math.abs(yearsDifference) === 1) technicalScore += 20; // Within 1 year
                        else if (Math.abs(yearsDifference) === 2) technicalScore += 10; // Within 2 years
                        else if (yearsDifference > 2) technicalScore += 5; // Late maintenance
                        else technicalScore -= 10; // Early maintenance penalty
                        
                        asset.technicalScore = technicalScore;
                    });
                    
                    // Sort by technical efficiency score
                    remainingAssets.sort((a, b) => b.technicalScore - a.technicalScore);
                    
                    for (let asset of remainingAssets) {
                        // Check for proximity benefits using Google Maps API
                        const proximateAssets = findProximateAssets(asset, yearlyAssets, schedule, year, proximityRadius);
                        
                        // Check if asset can be scheduled based on annual length limit
                        if (yearlyLength + asset.length <= maxLength) {
                            const drivers = getTechnicalSchedulingDrivers(asset, year);
                            
                            yearlyAssets.push({
                                ...asset,
                                year: new Date().getFullYear() + year - 1,  // Use actual year instead of iteration
                                proximityBenefit: proximateAssets.length > 0,
                                schedulingDrivers: drivers
                            });
                            
                            yearlyLength += asset.length;
                            
                            // Track risk coverage
                            if (asset.riskScore >= 15) {
                                totalRiskCoverage += 1;
                            }
                            
                            // Stop if length limit is nearly reached
                            if ((maxLength - yearlyLength) < 10) break; // Save capacity for minimum 10m asset
                        }
                    }
                    
                    schedule = schedule.concat(yearlyAssets);
                }
                
                updateProgress(100);
                setTimeout(() => {
                    hideProgressBar();
                    displayResults(schedule, totalRiskCoverage);
                    updateSystemStatus('Complete', 'status-ready');
                }, 500);
            }, 300);
        }
        
        function displayPrioritySummary(schedule) {
            // Calculate priority statistics for all assets
            const allAssetsWithScores = assets.map(asset => {
                const scheduleYear = schedule.find(s => s.id === asset.id)?.year;
                const totalScore = asset.technicalScore || calculateGlobalPriorityScore(asset, scheduleYear);
                return {
                    ...asset,
                    totalScore,
                    year: scheduleYear,
                    isScheduled: scheduleYear !== undefined
                };
            });
            
            const priorityStats = {
                critical: { scheduled: 0, unscheduled: 0, total: 0 },
                high: { scheduled: 0, unscheduled: 0, total: 0 },
                medium: { scheduled: 0, unscheduled: 0, total: 0 },
                low: { scheduled: 0, unscheduled: 0, total: 0 }
            };
            
            allAssetsWithScores.forEach(asset => {
                const priority = getPriorityLevel(asset.totalScore);
                priorityStats[priority].total++;
                if (asset.isScheduled) {
                    priorityStats[priority].scheduled++;
                } else {
                    priorityStats[priority].unscheduled++;
                }
            });
            
            // Update priority summary display
            const summaryElement = document.getElementById('prioritySummary');
            if (summaryElement) {
                summaryElement.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div style="text-align: center; padding: 12px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #DC2626;">
                            <div style="font-size: 24px; font-weight: bold; color: #DC2626;">${priorityStats.critical.total}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Critical Priority</div>
                            <div style="font-size: 11px; color: #666;">${priorityStats.critical.scheduled} scheduled | ${priorityStats.critical.unscheduled} pending</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #fffbeb; border-radius: 8px; border-left: 4px solid #F59E0B;">
                            <div style="font-size: 24px; font-weight: bold; color: #F59E0B;">${priorityStats.high.total}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">High Priority</div>
                            <div style="font-size: 11px; color: #666;">${priorityStats.high.scheduled} scheduled | ${priorityStats.high.unscheduled} pending</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10B981;">
                            <div style="font-size: 24px; font-weight: bold; color: #10B981;">${priorityStats.medium.total}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Medium Priority</div>
                            <div style="font-size: 11px; color: #666;">${priorityStats.medium.scheduled} scheduled | ${priorityStats.medium.unscheduled} pending</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6B7280;">
                            <div style="font-size: 24px; font-weight: bold; color: #6B7280;">${priorityStats.low.total}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Low Priority</div>
                            <div style="font-size: 11px; color: #666;">${priorityStats.low.scheduled} scheduled | ${priorityStats.low.unscheduled} pending</div>
                        </div>
                    </div>
                    
                    <div style="background: #f0f7ff; border: 1px solid #007AFF; border-radius: 6px; padding: 12px;">
                        <h4 style="margin: 0 0 8px 0; color: #007AFF; font-size: 14px;">💡 Priority Insights</h4>
                        <ul style="margin: 0; padding-left: 16px; font-size: 13px; color: #333; line-height: 1.6;">
                            ${priorityStats.critical.unscheduled > 0 ? `<li style="color: #DC2626;">⚠️ ${priorityStats.critical.unscheduled} critical assets remain unscheduled</li>` : '<li style="color: #10B981;">✅ All critical assets are scheduled</li>'}
                            ${priorityStats.high.unscheduled > 0 ? `<li style="color: #F59E0B;">⚠️ ${priorityStats.high.unscheduled} high-priority assets remain unscheduled</li>` : '<li style="color: #10B981;">✅ All high-priority assets are scheduled</li>'}
                            <li>📊 Total schedule coverage: ${Math.round((schedule.length / assets.length) * 100)}%</li>
                            <li>🎯 Risk-weighted coverage: ${Math.round(((priorityStats.critical.scheduled + priorityStats.high.scheduled) / (priorityStats.critical.total + priorityStats.high.total)) * 100)}%</li>
                        </ul>
                    </div>
                `;
            }
            
            // Create priority breakdown cards
            const breakdownElement = document.getElementById('priorityBreakdown');
            if (breakdownElement) {
                const criticalAssets = allAssetsWithScores.filter(a => getPriorityLevel(a.totalScore) === 'critical').sort((a, b) => b.totalScore - a.totalScore);
                const highAssets = allAssetsWithScores.filter(a => getPriorityLevel(a.totalScore) === 'high').sort((a, b) => b.totalScore - a.totalScore);
                
                breakdownElement.innerHTML = `
                    <div style="background: white; border: 1px solid #DC2626; border-radius: 8px; overflow: hidden;">
                        <div style="background: #DC2626; color: white; padding: 12px; font-weight: 600; font-size: 14px;">
                            🚨 Critical Priority Assets (${criticalAssets.length})
                        </div>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${criticalAssets.length > 0 ? criticalAssets.slice(0, 8).map(asset => `
                                <div style="padding: 8px 12px; border-bottom: 1px solid #eee; display: flex; justify-content: between; align-items: center;">
                                    <div>
                                        <span style="font-weight: 600; color: #DC2626;">${asset.id}</span>
                                        <span style="font-size: 12px; color: #666; margin-left: 8px;">${asset.isScheduled ? `Year ${asset.year}` : 'Unscheduled'}</span>
                                    </div>
                                    <div style="font-weight: bold; color: #DC2626; font-size: 12px;">${Math.round(asset.totalScore)}</div>
                                </div>
                            `).join('') : '<div style="padding: 20px; text-align: center; color: #666; font-size: 13px;">No critical priority assets</div>'}
                            ${criticalAssets.length > 8 ? `<div style="padding: 8px 12px; text-align: center; color: #666; font-size: 12px; font-style: italic;">... and ${criticalAssets.length - 8} more</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #F59E0B; border-radius: 8px; overflow: hidden;">
                        <div style="background: #F59E0B; color: white; padding: 12px; font-weight: 600; font-size: 14px;">
                            ⚠️ High Priority Assets (${highAssets.length})
                        </div>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${highAssets.length > 0 ? highAssets.slice(0, 8).map(asset => `
                                <div style="padding: 8px 12px; border-bottom: 1px solid #eee; display: flex; justify-content: between; align-items: center;">
                                    <div>
                                        <span style="font-weight: 600; color: #F59E0B;">${asset.id}</span>
                                        <span style="font-size: 12px; color: #666; margin-left: 8px;">${asset.isScheduled ? `Year ${asset.year}` : 'Unscheduled'}</span>
                                    </div>
                                    <div style="font-weight: bold; color: #F59E0B; font-size: 12px;">${Math.round(asset.totalScore)}</div>
                                </div>
                            `).join('') : '<div style="padding: 20px; text-align: center; color: #666; font-size: 13px;">No high priority assets</div>'}
                            ${highAssets.length > 8 ? `<div style="padding: 8px 12px; text-align: center; color: #666; font-size: 12px; font-style: italic;">... and ${highAssets.length - 8} more</div>` : ''}
                        </div>
                    </div>
                `;
            }
        }

        function displayResults(schedule, totalRiskCoverage = 0) {
            // Calculate technical efficiency metrics
            const totalLength = schedule.reduce((sum, asset) => sum + asset.length, 0);
            const highRiskAssets = assets.filter(asset => asset.riskScore >= 15).length;
            const proximityCoordinated = schedule.filter(asset => asset.proximityBenefit).length;
            
            // Ensure totalRiskCoverage is valid
            if (totalRiskCoverage === undefined || totalRiskCoverage === null || isNaN(totalRiskCoverage)) {
                // Recalculate risk coverage from scheduled assets
                totalRiskCoverage = schedule.filter(asset => asset.riskScore >= 15).length;
            }
            
            // Update metrics
            document.getElementById('totalCost').textContent = `${(totalLength/1000).toFixed(1)}km`;
            document.getElementById('riskReduction').textContent = `${totalRiskCoverage}/${highRiskAssets}`;
            document.getElementById('assetsScheduled').textContent = `${schedule.length}/${assets.length}`;
            
            
            // Update efficiency information
            const costChange = document.getElementById('costChange');
            const proximityEfficiency = schedule.length > 0 ? (proximityCoordinated / schedule.length * 100).toFixed(0) : 0;
            costChange.innerHTML = `${proximityEfficiency}% Coordinated`;
            costChange.style.color = proximityEfficiency >= 30 ? 'var(--success-green)' : proximityEfficiency >= 15 ? 'var(--warning-orange)' : 'var(--error-red)';
            
            // Display schedule
            const scheduleContainer = document.getElementById('scheduleResults');
            scheduleContainer.innerHTML = '';
            
            const groupedByYear = schedule.reduce((acc, asset) => {
                if (!acc[asset.year]) acc[asset.year] = [];
                acc[asset.year].push(asset);
                return acc;
            }, {});
            
            Object.keys(groupedByYear).sort().forEach(year => {
                const yearAssets = groupedByYear[year];
                const yearLength = yearAssets.reduce((sum, asset) => sum + asset.length, 0);
                const yearRiskAssets = yearAssets.filter(asset => asset.riskScore >= 15).length;
                
                const yearHeader = document.createElement('div');
                yearHeader.style.cssText = 'padding: 16px 20px; background: var(--background-tertiary); font-weight: 600; color: var(--primary-blue); border-bottom: 1px solid var(--border-color);';
                yearHeader.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Year ${year} (${yearAssets.length} assets - ${(yearLength/1000).toFixed(1)}km)</span>
                        <span style="font-size: 14px; color: var(--success-green);">
                            High Risk: ${yearRiskAssets} assets
                        </span>
                    </div>
                `;
                scheduleContainer.appendChild(yearHeader);
                
                
                // Create table for assets
                const table = document.createElement('table');
                table.style.cssText = 'width: 100%; border-collapse: collapse; margin: 0; font-size: 13px;';
                
                // Table header
                const headerRow = document.createElement('tr');
                headerRow.style.cssText = 'background: var(--background-tertiary); font-weight: 600; color: var(--primary-blue);';
                headerRow.innerHTML = `
                    <th style="padding: 10px; border: 1px solid var(--border-color); text-align: left;">Asset ID</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color); text-align: center;">Length (m)</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color); text-align: center;">Size (mm)</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color); text-align: center;">Risk Rating</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color); text-align: center;">Access</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color); text-align: center;">Bypass</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color); text-align: center;">Mobilization</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color); text-align: center;">Proximity</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color); text-align: center;">Total Score</th>
                `;
                table.appendChild(headerRow);
                
                // Table rows for assets
                yearAssets.forEach(asset => {
                    const row = document.createElement('tr');
                    row.style.cssText = 'border-bottom: 1px solid var(--border-color);';
                    
                    // Pastel color system
                    const trafficRed = '#FECACA';    // Pastel Red
                    const trafficAmber = '#FED7AA';  // Pastel Amber/Yellow
                    const trafficGreen = '#BBF7D0';  // Pastel Green
                    
                    // Risk color coding (High risk = Red, Medium = Amber, Low = Green)
                    let riskColor = trafficRed; // Red for high risk
                    if (asset.riskScore <= 5) riskColor = trafficGreen; // Green for low risk
                    else if (asset.riskScore <= 10) riskColor = trafficAmber; // Amber for medium risk
                    
                    // Access color coding (Good access = Green, Moderate = Amber, Difficult = Red)
                    let accessColor = trafficRed; // Red for difficult access
                    if (asset.accessScore >= 7) accessColor = trafficGreen; // Green for good access
                    else if (asset.accessScore >= 4) accessColor = trafficAmber; // Amber for moderate access
                    
                    // Mobilization color coding (Simple = Green, Moderate = Amber, Complex = Red)
                    let mobColor = trafficGreen; // Green for simple
                    if (asset.mobilizationComplexity >= 4) mobColor = trafficRed; // Red for complex
                    else if (asset.mobilizationComplexity >= 3) mobColor = trafficAmber; // Amber for moderate
                    
                    // Total score color coding
                    let scoreColor = trafficRed; // Red for low scores
                    const totalScore = asset.technicalScore || 0;
                    if (totalScore >= 120) scoreColor = trafficGreen; // Green for high scores
                    else if (totalScore >= 80) scoreColor = trafficAmber; // Amber for medium scores
                    
                    row.innerHTML = `
                        <td style="padding: 8px; border: 1px solid var(--border-color); font-weight: 500;">${asset.id}</td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">${asset.length}</td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">${asset.diameter}</td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; background-color: ${riskColor}; color: #374151; font-weight: 600;">
                            ${asset.riskCategory || 'Risk ' + asset.riskScore}
                        </td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; background-color: ${accessColor}; color: #374151; font-weight: 600;">
                            ${asset.accessScore}/10
                        </td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; background-color: ${asset.bypassRequired ? trafficRed : trafficGreen}; color: #374151; font-weight: 600;">
                            ${asset.bypassRequired ? 'Required' : 'No'}
                        </td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; background-color: ${mobColor}; color: #374151; font-weight: 600;">
                            ${asset.mobilizationComplexity}/5
                        </td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; background-color: ${asset.proximityBenefit ? trafficGreen : '#F3F4F6'}; color: #374151; font-weight: 600;">
                            ${asset.proximityBenefit ? '🔗 Yes' : 'No'}
                        </td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; background-color: ${scoreColor}; color: #374151; font-weight: 600;">
                            ${totalScore}
                        </td>
                    `;
                    table.appendChild(row);
                });
                
                scheduleContainer.appendChild(table);
            });
            
            
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('infoAlert').style.display = 'none';
        }
        
        function showProgressBar() {
            document.getElementById('progressBar').style.display = 'block';
        }
        
        function hideProgressBar() {
            document.getElementById('progressBar').style.display = 'none';
        }
        
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = `${percent}%`;
        }
        
        // Google Maps API proximity calculation
        function findProximateAssets(currentAsset, yearlyAssets, fullSchedule, currentYear, proximityRadius) {
            if (!window.google || !window.google.maps) {
                // Inform user about fallback mode
                if (apiStatus.status !== 'fallback') {
                    updateApiStatus('fallback', 'Google Maps API not loaded');
                    showNotification('⚠️ Using fallback distance calculations', 'warning');
                }
                
                // Fallback to simple distance calculation if Google Maps not available
                return yearlyAssets.filter(scheduled => {
                    if (scheduled.id === currentAsset.id) return false;
                    const distance = Math.sqrt(
                        Math.pow((currentAsset.x - scheduled.x) * 111000, 2) + 
                        Math.pow((currentAsset.y - scheduled.y) * 111000 * Math.cos(currentAsset.x * Math.PI / 180), 2)
                    );
                    return distance <= 500 && currentAsset.diameterCategory === scheduled.diameterCategory;
                });
            }
            
            try {
                const currentLocation = new google.maps.LatLng(currentAsset.x, currentAsset.y);
                const proximateAssets = [];
                
                // Check assets scheduled within 12 months (current year)
                const relevantAssets = [...yearlyAssets, ...fullSchedule.filter(a => a.year === currentYear)];
                
                for (const asset of relevantAssets) {
                    if (asset.id === currentAsset.id) continue;
                    
                    const assetLocation = new google.maps.LatLng(asset.x, asset.y);
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(currentLocation, assetLocation);
                    
                    // Check proximity (500m), diameter category, and timing constraints
                    if (distance <= 500 && 
                        currentAsset.diameterCategory === asset.diameterCategory) {
                        proximateAssets.push(asset);
                    }
                }
                
                return proximateAssets;
            } catch (error) {
                // API error during calculation
                updateApiStatus('fallback', 'API calculation error');
                showNotification('⚠️ Google Maps API error. Using fallback calculations.', 'warning');
                console.warn('Google Maps API error, using fallback calculation:', error);
                
                // Fallback calculation
                return yearlyAssets.filter(scheduled => {
                    if (scheduled.id === currentAsset.id) return false;
                    const distance = Math.sqrt(
                        Math.pow((currentAsset.x - scheduled.x) * 111000, 2) + 
                        Math.pow((currentAsset.y - scheduled.y) * 111000 * Math.cos(currentAsset.x * Math.PI / 180), 2)
                    );
                    return distance <= 500 && currentAsset.diameterCategory === scheduled.diameterCategory;
                });
            }
        }
        
        function updateSystemStatus(status, className) {
            const statusElement = document.getElementById('systemStatus');
            statusElement.textContent = status;
            statusElement.parentElement.className = `status-indicator ${className}`;
        }
        
        // Function to get API status information for display in results
        function getApiStatusInfo() {
            const statusInfo = {
                active: {
                    icon: '✅',
                    text: 'Google Maps API Active',
                    description: 'Using precise geographic distance calculations',
                    color: 'success'
                },
                fallback: {
                    icon: '⚠️',
                    text: 'Fallback Mode Active',
                    description: 'Using mathematical distance calculations (reduced accuracy)',
                    color: 'warning'
                },
                error: {
                    icon: '❌',
                    text: 'API Error',
                    description: 'Google Maps API encountered an error',
                    color: 'error'
                }
            };
            
            return statusInfo[apiStatus.status] || statusInfo.fallback;
        }
        
        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight(e) {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });
        
        // ==================== GOOGLE MAPS AND PRIORITY SYSTEM ====================
        
        // Global variables for map functionality
        let assetMap = null;
        let markers = [];
        let infoWindows = [];
        let heatmap = null;
        let schedule = []; // Will store optimized schedule
        let currentPriorityView = 'global';
        
        // Enhanced global priority calculation for all assets
        function calculateGlobalPriorityScore(asset, scheduleYear = null) {
            let totalScore = 0;
            
            // Base technical score (existing calculation)
            totalScore += calculateBaseTechnicalScore(asset);
            
            // Scheduling priority bonus/penalty
            if (scheduleYear) {
                totalScore += calculateSchedulingBonus(asset, scheduleYear);
            } else {
                // Penalty for unscheduled high-risk assets
                if (asset.riskScore >= 15) {
                    totalScore -= 50; // High penalty for unscheduled high-risk
                } else if (asset.riskScore >= 10) {
                    totalScore -= 25; // Medium penalty for unscheduled medium-risk
                }
            }
            
            // Proximity coordination bonus
            if (asset.proximityBenefit) {
                totalScore += 20;
            }
            
            // Age-based urgency (if recommended year is past)
            const currentYear = new Date().getFullYear();
            const recommendedYear = asset.recommendedYear || currentYear;
            if (recommendedYear < currentYear) {
                totalScore += (currentYear - recommendedYear) * 15; // 15 points per year overdue
            }
            
            return totalScore;
        }
        
        function calculateBaseTechnicalScore(asset) {
            let technicalScore = 0;
            
            // Risk priority (highest weight)
            if (asset.riskScore >= 20) technicalScore += 100;
            else if (asset.riskScore >= 15) technicalScore += 75;
            else if (asset.riskScore >= 10) technicalScore += 50;
            else technicalScore += 25;
            
            // Access efficiency factor
            if (asset.accessScore >= 7) technicalScore += 20;
            else if (asset.accessScore <= 3) technicalScore += 10;
            
            // Mobilization efficiency factor
            if (asset.mobilizationComplexity <= 2) technicalScore += 15;
            else if (asset.mobilizationComplexity >= 4) technicalScore += 5;
            
            // Bypass coordination factor
            if (!asset.bypassRequired) technicalScore += 10;
            else technicalScore += 5;
            
            // Work scope efficiency
            if (asset.length >= 500) technicalScore += 10;
            else if (asset.length <= 200) technicalScore += 5;
            
            return technicalScore;
        }
        
        function calculateSchedulingBonus(asset, scheduleYear) {
            const recommendedYear = asset.recommendedYear || new Date().getFullYear();
            const yearsDifference = scheduleYear - recommendedYear;
            
            if (yearsDifference === 0) return 30; // Perfect timing
            else if (Math.abs(yearsDifference) === 1) return 20; // Within 1 year
            else if (Math.abs(yearsDifference) === 2) return 10; // Within 2 years
            else if (yearsDifference > 2) return 5; // Late maintenance
            else return -10; // Early maintenance penalty
        }
        
        // Priority level classification
        function getPriorityLevel(score) {
            if (score >= 150) return 'critical';
            if (score >= 120) return 'high';
            if (score >= 80) return 'medium';
            return 'low';
        }
        
        function getPriorityColor(priority) {
            const colors = {
                critical: '#DC2626',
                high: '#F59E0B',
                medium: '#10B981', 
                low: '#6B7280'
            };
            return colors[priority] || '#6B7280';
        }
        
        // Initialize Google Maps for asset visualization
        function initializeAssetMap() {
            if (!document.getElementById('assetMap')) return;
            
            // Check if Google Maps is available and API status
            if (!window.google || !window.google.maps || apiStatus.status === 'fallback') {
                const mapElement = document.getElementById('assetMap');
                mapElement.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; border-radius: 8px; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🗺️</div>
                        <h3 style="color: #666; margin-bottom: 12px;">Map View Unavailable</h3>
                        <p style="color: #888; text-align: center; max-width: 400px;">
                            Google Maps API is not available. The system is using mathematical calculations for proximity detection.
                            All optimization features remain fully functional.
                        </p>
                        <div style="margin-top: 20px; padding: 12px 24px; background: #e3f2fd; border-radius: 6px; color: #1976d2;">
                            📊 Fallback Mode Active - No Visual Impact on Results
                        </div>
                    </div>
                `;
                return;
            }
            
            try {
                // Initialize Google Map
                assetMap = new google.maps.Map(document.getElementById('assetMap'), {
                    zoom: 12,
                    center: { lat: -37.8136, lng: 144.9631 }, // Default to Melbourne
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });
                
                updateMapWithCurrentData();
                console.log('Asset map initialized successfully');
            } catch (error) {
                console.error('Failed to initialize asset map:', error);
                showNotification('⚠️ Map initialization failed. Check Google Maps API.', 'warning');
            }
        }
        
        // Update map with current data
        function updateMapWithCurrentData() {
            if (!assetMap || !assets.length) return;
            
            // Calculate scores for all assets if not already done
            const assetsWithScores = assets.map(asset => {
                const scheduleYear = schedule.find(s => s.id === asset.id)?.year;
                return {
                    ...asset,
                    totalScore: asset.technicalScore || calculateGlobalPriorityScore(asset, scheduleYear),
                    year: scheduleYear
                };
            });
            
            createAssetMarkers(assetsWithScores);
            updateMapStats(assetsWithScores);
            updateYearFilter();
            updatePriorityRanking(assetsWithScores);
        }
        
        // Create priority-based markers
        function createAssetMarkers(assets) {
            // Clear existing markers
            clearMarkers();
            
            if (!assetMap) return;
            
            // Calculate map bounds
            const bounds = new google.maps.LatLngBounds();
            
            assets.forEach(asset => {
                const priority = getPriorityLevel(asset.totalScore);
                const isScheduled = asset.year !== undefined;
                
                // Create marker with priority-based styling
                const marker = new google.maps.Marker({
                    position: { lat: asset.x || asset.lat, lng: asset.y || asset.lng },
                    map: assetMap,
                    title: `${asset.id} - ${priority} Priority`,
                    icon: createPriorityMarker(priority, isScheduled),
                    animation: isScheduled ? google.maps.Animation.DROP : null
                });
                
                // Create info window with detailed asset information
                const infoWindow = new google.maps.InfoWindow({
                    content: createAssetInfoWindow(asset)
                });
                
                // Add click event
                marker.addListener('click', () => {
                    // Close all other info windows
                    infoWindows.forEach(iw => iw.close());
                    infoWindow.open(assetMap, marker);
                });
                
                // Store references
                markers.push(marker);
                infoWindows.push(infoWindow);
                
                // Extend bounds
                bounds.extend({ lat: asset.x || asset.lat, lng: asset.y || asset.lng });
            });
            
            // Fit map to show all markers
            if (markers.length > 0) {
                assetMap.fitBounds(bounds);
            }
        }
        
        function createPriorityMarker(priority, isScheduled) {
            const colors = {
                critical: '#DC2626',
                high: '#F59E0B', 
                medium: '#10B981',
                low: '#6B7280'
            };
            
            const color = colors[priority];
            
            return {
                path: google.maps.SymbolPath.CIRCLE,
                scale: isScheduled ? 12 : 10,
                fillColor: color,
                fillOpacity: 0.8,
                strokeColor: '#FFFFFF',
                strokeWeight: 2
            };
        }
        
        function createAssetInfoWindow(asset) {
            const priority = getPriorityLevel(asset.totalScore);
            const isScheduled = asset.year !== undefined;
            
            return `
                <div style="min-width: 250px; font-family: -apple-system, sans-serif;">
                    <div style="background: ${getPriorityColor(priority)}; color: white; padding: 8px; margin: -8px -8px 8px -8px; border-radius: 4px 4px 0 0;">
                        <h3 style="margin: 0; font-size: 16px;">${asset.id}</h3>
                        <p style="margin: 4px 0 0 0; font-size: 12px;">${priority.toUpperCase()} Priority</p>
                    </div>
                    
                    <div style="font-size: 13px; line-height: 1.4;">
                        <p><strong>Total Score:</strong> ${Math.round(asset.totalScore || 0)}</p>
                        <p><strong>Risk Rating:</strong> ${asset.riskScore}/25</p>
                        <p><strong>Length:</strong> ${asset.length}m</p>
                        <p><strong>Diameter:</strong> ${asset.diameter}mm</p>
                        <p><strong>Access Score:</strong> ${asset.accessScore}/10</p>
                        <p><strong>Status:</strong> ${isScheduled ? `Scheduled for Year ${asset.year}` : 'Unscheduled'}</p>
                        
                        ${asset.proximityBenefit ? '<p style="color: #10B981;"><strong>✓ Proximity Coordinated</strong></p>' : ''}
                        
                        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #eee;">
                            <button onclick="showAssetDetails('${asset.id}')" style="background: #007AFF; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            infoWindows.forEach(iw => iw.close());
            infoWindows = [];
        }
        
        // Map control functions
        function fitMapToAssets() {
            if (!assetMap || markers.length === 0) return;
            
            const bounds = new google.maps.LatLngBounds();
            markers.forEach(marker => bounds.extend(marker.getPosition()));
            assetMap.fitBounds(bounds);
        }
        
        function toggleHeatmap() {
            if (!assetMap) return;
            
            if (heatmap) {
                heatmap.setMap(null);
                heatmap = null;
            } else {
                const heatmapData = markers.map(marker => ({
                    location: marker.getPosition(),
                    weight: getMarkerWeight(marker)
                }));
                
                heatmap = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    map: assetMap,
                    radius: 50,
                    opacity: 0.7
                });
            }
        }
        
        function getMarkerWeight(marker) {
            const assetId = marker.getTitle().split(' - ')[0];
            const asset = assets.find(a => a.id === assetId);
            if (!asset) return 1;
            
            const score = asset.totalScore || asset.technicalScore || 0;
            return Math.max(1, score / 20); // Normalize weight
        }
        
        // Filtering system
        function applyMapFilters() {
            const priorityFilter = document.getElementById('priorityFilter')?.value || 'all';
            const scheduleFilter = document.getElementById('scheduleFilter')?.value || 'all';
            const yearFilter = document.getElementById('yearFilter')?.value || 'all';
            
            let filteredAssets = assets.map(asset => {
                const scheduleYear = schedule.find(s => s.id === asset.id)?.year;
                return {
                    ...asset,
                    totalScore: asset.technicalScore || calculateGlobalPriorityScore(asset, scheduleYear),
                    year: scheduleYear
                };
            });
            
            // Apply priority filter
            if (priorityFilter !== 'all') {
                filteredAssets = filteredAssets.filter(asset => {
                    const priority = getPriorityLevel(asset.totalScore);
                    return priority === priorityFilter;
                });
            }
            
            // Apply schedule filter
            if (scheduleFilter !== 'all') {
                filteredAssets = filteredAssets.filter(asset => {
                    const isScheduled = asset.year !== undefined;
                    return scheduleFilter === 'scheduled' ? isScheduled : !isScheduled;
                });
            }
            
            // Apply year filter
            if (yearFilter !== 'all') {
                filteredAssets = filteredAssets.filter(asset => 
                    asset.year === parseInt(yearFilter)
                );
            }
            
            // Update map with filtered assets
            createAssetMarkers(filteredAssets);
            updateMapStats(filteredAssets);
        }
        
        function updateMapStats(filteredAssets) {
            const stats = {
                total: filteredAssets.length,
                critical: filteredAssets.filter(a => getPriorityLevel(a.totalScore || 0) === 'critical').length,
                high: filteredAssets.filter(a => getPriorityLevel(a.totalScore || 0) === 'high').length,
                scheduled: filteredAssets.filter(a => a.year !== undefined).length,
                unscheduled: filteredAssets.filter(a => a.year === undefined).length
            };
            
            // Update stats display
            const mapStatsElement = document.getElementById('mapStats');
            if (mapStatsElement) {
                mapStatsElement.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: #007AFF;">${stats.total}</div>
                            <div style="font-size: 12px; color: #666;">Total Assets</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #fef2f2; border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: #DC2626;">${stats.critical}</div>
                            <div style="font-size: 12px; color: #666;">Critical</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #fffbeb; border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: #F59E0B;">${stats.high}</div>
                            <div style="font-size: 12px; color: #666;">High Priority</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #f0fdf4; border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: #10B981;">${stats.scheduled}</div>
                            <div style="font-size: 12px; color: #666;">Scheduled</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function updateYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            if (!yearFilter) return;
            
            const years = [...new Set(schedule.map(s => s.year))].sort();
            yearFilter.innerHTML = '<option value="all">All Years</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">Year ${year}</option>`;
            });
        }
        
        // Priority ranking system
        function updatePriorityRanking(assetsWithScores) {
            const container = document.getElementById('priorityRanking');
            if (!container) return;
            
            displayGlobalPriorityView(assetsWithScores);
        }
        
        function togglePriorityView(viewType) {
            currentPriorityView = viewType;
            
            // Update button states
            ['globalViewBtn', 'yearViewBtn', 'riskViewBtn'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.className = btn.className.replace('btn-primary', 'btn-secondary');
                }
            });
            
            const activeBtn = document.getElementById(viewType + 'ViewBtn');
            if (activeBtn) {
                activeBtn.className = activeBtn.className.replace('btn-secondary', 'btn-primary');
            }
            
            // Calculate scores for all assets
            const assetsWithScores = assets.map(asset => {
                const scheduleYear = schedule.find(s => s.id === asset.id)?.year;
                return {
                    ...asset,
                    totalScore: asset.technicalScore || calculateGlobalPriorityScore(asset, scheduleYear),
                    year: scheduleYear
                };
            });
            
            // Display appropriate view
            switch(viewType) {
                case 'global':
                    displayGlobalPriorityView(assetsWithScores);
                    break;
                case 'year':
                    displayYearGroupedView(assetsWithScores);
                    break;
                case 'risk':
                    displayRiskGroupedView(assetsWithScores);
                    break;
            }
        }
        
        function displayGlobalPriorityView(assetsWithScores) {
            const container = document.getElementById('priorityRanking');
            if (!container) return;
            
            // Sort by total score
            const sortedAssets = assetsWithScores.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
            
            let html = `
                <div style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                    <h4 style="margin: 0; color: #007AFF;">Global Priority Ranking (${sortedAssets.length} assets)</h4>
                    <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">All assets ranked by total priority score</p>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            sortedAssets.forEach((asset, index) => {
                const priority = getPriorityLevel(asset.totalScore || 0);
                const isScheduled = asset.year !== undefined;
                const priorityColor = getPriorityColor(priority);
                
                html += `
                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; gap: 12px;">
                        <div style="font-weight: bold; color: #666; min-width: 30px;">#${index + 1}</div>
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${priorityColor}; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 2px;">${asset.id}</div>
                            <div style="font-size: 12px; color: #666;">
                                Risk: ${asset.riskScore}/25 | Length: ${asset.length}m | ${isScheduled ? `Scheduled Year ${asset.year}` : 'Unscheduled'}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: ${priorityColor};">${Math.round(asset.totalScore || 0)}</div>
                            <div style="font-size: 11px; color: #666; text-transform: uppercase;">${priority}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function displayYearGroupedView(assetsWithScores) {
            const container = document.getElementById('priorityRanking');
            if (!container) return;
            
            // Group by year
            const groups = { unscheduled: [] };
            assetsWithScores.forEach(asset => {
                const year = asset.year || 'unscheduled';
                if (!groups[year]) groups[year] = [];
                groups[year].push(asset);
            });
            
            let html = `
                <div style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                    <h4 style="margin: 0; color: #007AFF;">Assets Grouped by Schedule Year</h4>
                    <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">Assets organized by their scheduled maintenance year</p>
                </div>
            `;
            
            // Sort years
            const sortedYears = Object.keys(groups).sort((a, b) => {
                if (a === 'unscheduled') return 1;
                if (b === 'unscheduled') return -1;
                return parseInt(a) - parseInt(b);
            });
            
            sortedYears.forEach(year => {
                const yearAssets = groups[year].sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
                const yearTitle = year === 'unscheduled' ? 'Unscheduled Assets' : `Year ${year}`;
                
                html += `
                    <div style="margin-bottom: 20px;">
                        <h5 style="margin: 0 0 8px 0; padding: 8px; background: ${year === 'unscheduled' ? '#fff3cd' : '#e3f2fd'}; border-radius: 4px; color: ${year === 'unscheduled' ? '#856404' : '#1565c0'};">
                            ${yearTitle} (${yearAssets.length} assets)
                        </h5>
                        <div style="border-left: 3px solid ${year === 'unscheduled' ? '#ffc107' : '#2196f3'}; padding-left: 12px;">
                `;
                
                yearAssets.forEach((asset, index) => {
                    const priority = getPriorityLevel(asset.totalScore || 0);
                    const priorityColor = getPriorityColor(priority);
                    
                    html += `
                        <div style="display: flex; align-items: center; padding: 8px 0; gap: 12px; ${index < yearAssets.length - 1 ? 'border-bottom: 1px solid #eee;' : ''}">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: ${priorityColor};"></div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">${asset.id}</span>
                                <span style="font-size: 12px; color: #666; margin-left: 8px;">Risk: ${asset.riskScore}/25</span>
                            </div>
                            <div style="font-weight: bold; color: ${priorityColor};">${Math.round(asset.totalScore || 0)}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }
        
        function displayRiskGroupedView(assetsWithScores) {
            const container = document.getElementById('priorityRanking');
            if (!container) return;
            
            // Group by risk level
            const riskGroups = {
                'Extreme (20-25)': [],
                'Very High (15-19)': [],
                'High (10-14)': [],
                'Medium (5-9)': [],
                'Low (1-4)': []
            };
            
            assetsWithScores.forEach(asset => {
                const riskScore = asset.riskScore || 0;
                if (riskScore >= 20) riskGroups['Extreme (20-25)'].push(asset);
                else if (riskScore >= 15) riskGroups['Very High (15-19)'].push(asset);
                else if (riskScore >= 10) riskGroups['High (10-14)'].push(asset);
                else if (riskScore >= 5) riskGroups['Medium (5-9)'].push(asset);
                else riskGroups['Low (1-4)'].push(asset);
            });
            
            let html = `
                <div style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                    <h4 style="margin: 0; color: #007AFF;">Assets Grouped by Risk Level</h4>
                    <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">Assets organized by their risk rating, sorted by total score within each group</p>
                </div>
            `;
            
            Object.entries(riskGroups).forEach(([riskLevel, assets]) => {
                if (assets.length === 0) return;
                
                const sortedAssets = assets.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
                const riskColor = riskLevel.includes('Extreme') ? '#DC2626' : 
                                  riskLevel.includes('Very High') ? '#F59E0B' :
                                  riskLevel.includes('High') ? '#FF9F0A' :
                                  riskLevel.includes('Medium') ? '#10B981' : '#6B7280';
                
                html += `
                    <div style="margin-bottom: 20px;">
                        <h5 style="margin: 0 0 8px 0; padding: 8px; background: ${riskColor}20; border-radius: 4px; color: ${riskColor}; border-left: 4px solid ${riskColor};">
                            ${riskLevel} - ${sortedAssets.length} assets
                        </h5>
                        <div style="border-left: 3px solid ${riskColor}; padding-left: 12px;">
                `;
                
                sortedAssets.forEach((asset, index) => {
                    const priority = getPriorityLevel(asset.totalScore || 0);
                    const isScheduled = asset.year !== undefined;
                    
                    html += `
                        <div style="display: flex; align-items: center; padding: 8px 0; gap: 12px; ${index < sortedAssets.length - 1 ? 'border-bottom: 1px solid #eee;' : ''}">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">${asset.id}</span>
                                <span style="font-size: 12px; color: #666; margin-left: 8px;">
                                    ${isScheduled ? `Year ${asset.year}` : 'Unscheduled'} | Length: ${asset.length}m
                                </span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: ${getPriorityColor(priority)};">${Math.round(asset.totalScore || 0)}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">${priority}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // Export functionality
        function exportMapData() {
            if (assets.length === 0) {
                showNotification('⚠️ No asset data available to export', 'warning');
                return;
            }
            
            const assetsWithScores = assets.map(asset => {
                const scheduleYear = schedule.find(s => s.id === asset.id)?.year;
                const totalScore = asset.technicalScore || calculateGlobalPriorityScore(asset, scheduleYear);
                return {
                    id: asset.id,
                    lat: asset.x || asset.lat,
                    lng: asset.y || asset.lng,
                    priority: getPriorityLevel(totalScore),
                    totalScore: Math.round(totalScore),
                    riskScore: asset.riskScore,
                    scheduled: asset.year !== undefined,
                    year: scheduleYear,
                    length: asset.length,
                    diameter: asset.diameter
                };
            });
            
            const mapData = {
                assets: assetsWithScores,
                exportDate: new Date().toISOString(),
                summary: {
                    total: assetsWithScores.length,
                    critical: assetsWithScores.filter(a => a.priority === 'critical').length,
                    high: assetsWithScores.filter(a => a.priority === 'high').length,
                    scheduled: assetsWithScores.filter(a => a.scheduled).length
                }
            };
            
            const dataStr = JSON.stringify(mapData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `asset-priority-map-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('✅ Map data exported successfully', 'success');
        }
        
        // Utility functions
        function showAssetDetails(assetId) {
            // Find the asset and show optimization tab with details
            const asset = assets.find(a => a.id === assetId);
            if (asset) {
                showTab('optimization');
                // Could add logic to highlight specific asset in results
            }
        }
        
        // Enhanced showTab function to initialize map
        const originalShowTab = window.showTab;
        window.showTab = function(tabId) {
            if (originalShowTab) {
                originalShowTab(tabId);
            } else {
                // Fallback implementation
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                
                const targetPane = document.getElementById(tabId);
                const targetButton = document.querySelector(`[onclick="showTab('${tabId}')"]`);
                
                if (targetPane) targetPane.classList.add('active');
                if (targetButton) targetButton.classList.add('active');
            }
            
            // Initialize map when mapped-locations tab is shown
            if (tabId === 'mapped-locations') {
                setTimeout(() => {
                    if (!assetMap) {
                        initializeAssetMap();
                    } else {
                        updateMapWithCurrentData();
                    }
                }, 100);
            }
            
            currentTab = tabId;
        };
        
        // Update the optimization results to include schedule data
        const originalDisplayResults = window.displayResults;
        window.displayResults = function(optimizedSchedule) {
            schedule = optimizedSchedule; // Store schedule globally
            if (originalDisplayResults) {
                originalDisplayResults(optimizedSchedule);
            }
            // Update map data if on mapped locations tab
            if (currentTab === 'mapped-locations') {
                updateMapWithCurrentData();
            }
        };
    </script>
</body>
</html>